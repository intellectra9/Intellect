name: Generate Images

on:
  workflow_dispatch:

permissions:
  contents: write  # Allows push access

jobs:
  generate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install requests

      - name: Generate images inline
        env:
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
        run: |
          python - <<EOF
          import os
          import re
          import json
          import requests
          import time

          API_KEY = os.getenv("TOGETHER_API_KEY")
          API_URL = "https://api.together.xyz/v1/images/generations"
          HEADERS = {
              "Authorization": f"Bearer {API_KEY}",
              "Content-Type": "application/json"
          }

          IMAGES_DIR = "Images"
          VISUALS_JSON = "Visuals/visuals.json"
          NUM_IMAGES = 30

          os.makedirs(IMAGES_DIR, exist_ok=True)

          def find_highest_image_number():
              pattern = re.compile(r"i(\d+)\.png$")
              max_num = 0
              for fname in os.listdir(IMAGES_DIR):
                  match = pattern.match(fname)
                  if match:
                      num = int(match.group(1))
                      max_num = max(max_num, num)
              return max_num

          last_image_num = find_highest_image_number()
          next_image_num = last_image_num + 1
          print(f"Last image: i{last_image_num}. Next: i{next_image_num}")

          with open(VISUALS_JSON, "r") as f:
              visuals = json.load(f)

          available_prompts = sorted(visuals, key=lambda x: x["number"])
          prompts_to_generate = [item for item in available_prompts if item["number"] >= next_image_num][:NUM_IMAGES]

          if not prompts_to_generate:
              print("No new prompts to generate.")
              exit(0)

          for item in prompts_to_generate:
              number = item["number"]
              prompt = item["prompt"]

              print(f"Generating i{number}...")

              payload = {
                  "model": "black-forest-labs/FLUX.1-schnell-Free",
                  "prompt": prompt,
                  "steps": 4
              }

              try:
                  response = requests.post(API_URL, headers=HEADERS, json=payload)
                  response.raise_for_status()
                  data = response.json()

                  if "data" in data and data["data"]:
                      image_url = data["data"][0]["url"]
                      img_data = requests.get(image_url).content
                      filename = os.path.join(IMAGES_DIR, f"i{number}.png")
                      with open(filename, "wb") as f:
                          f.write(img_data)
                      print(f"Saved: {filename}")
                  else:
                      print(f"API error: {data}")

              except Exception as e:
                  print(f"Error generating i{number}: {e}")

              time.sleep(1)

          print(f"Done. Generated {len(prompts_to_generate)} images.")
          EOF

      - name: Configure Git
        run: |
          git config --global user.name "intellectra9"
          git config --global user.email "intellectra9@outlook.com"

      - name: Commit and push generated images
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Check if Images directory and files exist
          if [ ! -d "Images" ] || [ -z "$(ls -A Images)" ]; then
            echo "No images found in Images directory. Skipping commit."
            exit 0
          fi
          
          git add Images/
          timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          commit_message="üñºÔ∏è Generated images: ${timestamp}"
          
          # Check if changes exist before committing
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          
          git commit -m "$commit_message"
          git remote set-url origin https://x-access-token:${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git
          git push
